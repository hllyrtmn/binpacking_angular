<div class="logistics-container">
  <!-- Page Header -->
  <div class="logistics-header">
    <div class="header-icon">
      <mat-icon>assignment</mat-icon>
    </div>
    <div class="header-titles">
      <h1>İhracat Sipariş Bildirimi</h1>
      <p class="header-subtitle">
        Siparişlerin detaylarını yönetin ve takip edin
      </p>
    </div>
  </div>

  <!-- Empty State Card -->
  @if(!orderSignal() && !isLoadingSignal() ){
  <div class="logistics-card">
    <div class="empty-state">
      <div class="empty-icon">
        <mat-icon>description</mat-icon>
      </div>
      <h3>Sipariş Bilgisi Bulunamadı</h3>
      <p>
        Mevcut bir sipariş bilgisi bulunmuyor. Excel dosyası yükleyebilir veya
        manuel olarak sipariş detayı ekleyebilirsiniz.
      </p>

      <div class="action-options">
        <button mat-raised-button class="action-button" (click)="createOrder()">
          <mat-icon>add</mat-icon>
          <span>Manuel Giriş</span>
        </button>

        <div class="divider">
          <span>veya</span>
        </div>

        <div class="file-upload-container">
          <button mat-raised-button class="action-button secondary" (click)="fileInput.click()"
            [disabled]="excelUpload">
            <mat-icon>file_upload</mat-icon>
            <span>{{ file?.name || "Excel Dosyası Seç" }}</span>
          </button>
          <input (change)="onFileSelected($event)" #fileInput type="file" accept=".pdf,.xls,.xlsx" hidden />
        </div>
      </div>
    </div>
  </div>
  }
  <!-- Order Details Dashboard -->
  @if (orderSignal() && !isLoadingSignal()) {
  <div class="details-section">
    <!-- Order Summary -->
    <div class="dashboard-panel">
      <!-- Sipariş Tarihi -->
      <div class="dashboard-item">
        <div class="dashboard-icon">
          <mat-icon>event</mat-icon>
        </div>
        <div class="dashboard-info">
          <span class="dashboard-label">Sipariş Tarihi</span>
          <div class="dashboard-value-container">
            <mat-form-field class="edit-field" appearance="outline">
              <input readonly matInput [matDatepicker]="picker" [value]="orderSignal()?.date"
                (dateChange)="onOrderFieldChange('date', $event.value)" placeholder="Tarih seçin" required />
              <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
              @if(!orderSignal()?.date){
              <mat-error>
                Sipariş tarihi zorunludur
              </mat-error>}
            </mat-form-field>
          </div>
        </div>
      </div>

      <!-- Müşteri -->
      <div class="dashboard-item">
        <div class="dashboard-icon">
          <mat-icon>business</mat-icon>
        </div>
        <div class="dashboard-info">
          <span class="dashboard-label">Müşteri</span>
          <div class="dashboard-value-container">
            <mat-form-field class="edit-field" appearance="outline">
              <mat-select [value]="orderSignal()?.company_relation" (selectionChange)="onCompanyChange($event.value)"
                placeholder="Müşteri seçin" [compareWith]="compareCompanies" required>
                @for (company of targetCompanies; track company.id) {
                <mat-option [value]="company">
                  {{ company.target_company_name }}
                </mat-option>}
              </mat-select>
              @if(!orderSignal()?.company_relation){
              <mat-error>
                Müşteri seçimi zorunludur
              </mat-error>}
            </mat-form-field>
          </div>
        </div>
      </div>

      <!-- Tır Bilgisi -->
      <div class="dashboard-item">
        <div class="dashboard-icon">
          <mat-icon>local_shipping</mat-icon>
        </div>
        <div class="dashboard-info">
          <span class="dashboard-label">Tır</span>
          <div class="dashboard-value-container">
            <mat-form-field class="edit-field" appearance="outline">
              <mat-select [value]="orderSignal()?.truck" (selectionChange)="onTruckChange($event.value)"
                placeholder="Tır seçin" [compareWith]="compareObjects" required>
                @for(truck of trucks; track truck.id){
                <mat-option [value]="truck">
                  {{ truck.name }}
                </mat-option>}
              </mat-select>
              @if(!orderSignal()?.truck){
              <mat-error>
                Tır seçimi zorunludur
              </mat-error>}
            </mat-form-field>
          </div>
        </div>
      </div>

      <!-- Ağırlık Tipi -->
      <div class="dashboard-item">
        <div class="dashboard-icon">
          <mat-icon>category</mat-icon>
        </div>
        <div class="dashboard-info">
          <span class="dashboard-label">Ağırlık Tipi</span>
          <div class="dashboard-value-container">
            <mat-form-field class="edit-field" appearance="outline">
              <mat-select [value]="orderSignal()?.weight_type" (selectionChange)="onWeightTypeChange($event.value)"
                placeholder="Ağırlık tipi seçin" [compareWith]="compareWeightTypes" required>
                <mat-option value="eco">Eco</mat-option>
                <mat-option value="std">Std</mat-option>
                <mat-option value="pre">Pre</mat-option>
              </mat-select>
              @if(!orderSignal()?.weight_type) {
              <mat-error>
                Ağırlık tipi seçimi zorunludur
              </mat-error>}
            </mat-form-field>
          </div>
        </div>
      </div>

      <!-- Maksimum Sıra Adedi -->
      <div class="dashboard-item">
        <div class="dashboard-icon">
          <mat-icon>category</mat-icon>
        </div>
        <div class="dashboard-info">
          <span class="dashboard-label">Maksimum Kat Adedi</span>
          <div class="dashboard-value-container">
            <div class="units-input-container">
              <!-- Azaltma butonu -->
              <button mat-icon-button
                      (click)="onUnitsDecrease()"
                      [disabled]="isMinimumUnits()"
                      type="button"
                      class="unit-button">
                <mat-icon>remove</mat-icon>
              </button>

              <!-- Input alanı - FormControl'e bağlı -->
              <mat-form-field class="units-field" appearance="outline">
                <input matInput
                      type="number"
                      [formControl]="unitsControl"
                      readonly
                      min="1"
                      step="1"
                      placeholder="Kat adedi">
              </mat-form-field>

              <!-- Artırma butonu -->
              <button mat-icon-button
                      (click)="onUnitsIncrease()"
                      type="button"
                      class="unit-button">
                <mat-icon>add</mat-icon>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- Order Details Table -->
    <div class="logistics-card">
      <div class="section-header with-action">
        <div class="header-title">
          <mat-icon>list_alt</mat-icon>
          <h2>Sipariş Detayları</h2>
        </div>
      </div>

        <app-generic-table [externalData]="orderDetailsSignal()" [externalTotalCount]="orderDetailsSignal().length"
          [displayedColumns]="displayedColumns" [nestedDisplayColumns]="nestedDisplayColumns"
          [parentId]="orderSignal().id" [useParentId]="true" [parentIdFieldName]="'order_id'" [title]="''"
          [showRowNumbers]="true" (addClick)="openOrderDetailAddDialog()"
          (externalDataUpdate)="updateOrderDetail($event)" (externalDataDelete)="deleteOrderDetail($event)"
          [excludeFields]="excludeFields">
        </app-generic-table>

      <div class="summary-footer">
        <div class="summary-content">
          <div class="summary-metrics">
            <div class="metric">
              <mat-icon>inventory_2</mat-icon>
              <span>{{ orderDetailsSignal().length }} Kalem</span>
            </div>
            <div class="metric">
              <mat-icon>scale</mat-icon>
              <span>{{ totalWeight().toFixed(2) }} kg</span>
            </div>
          </div>
          <div class="status-badge">
            <span class="status-dot active"></span>
            <span>Aktif</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  }


  <!-- Navigation Controls -->
  <div class="navigation-controls">
    <button mat-raised-button class="next-button" (click)="submit()"
      [disabled]="!orderSignal() || !isFormValid()">
      <span>{{isDirtySignal() ? "kaydet ve ilerle" : "ileri"}}</span>
      <mat-icon>arrow_forward</mat-icon>
    </button>

  </div>

</div>
